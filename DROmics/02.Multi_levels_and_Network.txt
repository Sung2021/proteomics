# DRomics: Multi-level 비교 및 Network 분석

## 1. Multi-omics Level 비교

여러 molecular level (transcriptomics, proteomics, metabolomics)의 결과를 통합 분석합니다.

### 1.1 데이터 준비 및 개별 분석

```r
library(DRomics)
library(ggplot2)

# === Level 1: Transcriptomics ===
trans_data <- RNAseqdata("transcriptomics.txt", transfo.method = "rlog")
s_trans <- itemselect(trans_data, FDR = 0.01)
f_trans <- drcfit(s_trans)
r_trans <- bmdcalc(f_trans)
b_trans <- bmdboot(r_trans, niter = 500)

# Annotation 병합
trans_annot <- read.table("trans_annotation.txt", 
                          header = TRUE, 
                          stringsAsFactors = TRUE)
trans_extended <- merge(b_trans$res, trans_annot, 
                        by.x = "id", by.y = "gene_id")

# === Level 2: Proteomics ===
proteo_data <- continuousomicdata("proteomics.txt")
s_proteo <- itemselect(proteo_data, FDR = 0.01)
f_proteo <- drcfit(s_proteo)
r_proteo <- bmdcalc(f_proteo)
b_proteo <- bmdboot(r_proteo, niter = 500)

# Annotation 병합
proteo_annot <- read.table("proteo_annotation.txt", 
                           header = TRUE, 
                           stringsAsFactors = TRUE)
proteo_extended <- merge(b_proteo$res, proteo_annot,
                         by.x = "id", by.y = "protein_id")

# === Level 3: Metabolomics ===
metab_data <- continuousomicdata("metabolomics.txt")
s_metab <- itemselect(metab_data, FDR = 0.01)
f_metab <- drcfit(s_metab)
r_metab <- bmdcalc(f_metab)
b_metab <- bmdboot(r_metab, niter = 500)

# Annotation 병합
metab_annot <- read.table("metab_annotation.txt",
                          header = TRUE,
                          stringsAsFactors = TRUE)
metab_extended <- merge(b_metab$res, metab_annot,
                        by.x = "id", by.y = "metabolite_id")
```

### 1.2 Multi-level 데이터 통합

```r
# Level identifier 추가
trans_extended$omics_level <- "transcriptomics"
proteo_extended$omics_level <- "proteomics"
metab_extended$omics_level <- "metabolomics"

# 공통 pathway 컬럼명 통일 (예시)
# 각 데이터의 annotation 컬럼명이 다를 수 있음
colnames(trans_extended)[colnames(trans_extended) == "pathway"] <- "path_class"
colnames(proteo_extended)[colnames(proteo_extended) == "pathway"] <- "path_class"
colnames(metab_extended)[colnames(metab_extended) == "pathway"] <- "path_class"

# 전체 데이터 병합
multiomics_res <- rbind(trans_extended, proteo_extended, metab_extended)

# Factor level 설정
multiomics_res$omics_level <- factor(multiomics_res$omics_level,
                                     levels = c("metabolomics", 
                                               "proteomics", 
                                               "transcriptomics"))
```

### 1.3 Level간 비교 시각화

```r
# === 1) BMD 분포 비교 (전체) ===
# 중복 제거 (같은 item이 여러 pathway에 속할 수 있음)
unique_items <- multiomics_res[!duplicated(multiomics_res$id), ]

bmdplot(unique_items,
        BMDtype = "zSD",
        facetby = "omics_level",
        colorby = "trend",
        add.CI = TRUE) + 
  theme_bw() +
  labs(title = "BMD distribution across omics levels")

# === 2) BMD 분포 비교 (Level별, Pathway별) ===
bmdplot(multiomics_res,
        BMDtype = "zSD",
        facetby = "path_class",
        colorby = "omics_level",
        add.CI = TRUE) +
  theme_bw() +
  theme(strip.text = element_text(size = 8))

# === 3) Sensitivity plot (Pathway별, Level별) ===
sensitivityplot(multiomics_res,
                group = "path_class",
                colorby = "omics_level",
                BMDsummary = "first.quartile") +
  theme_bw() +
  labs(title = "Pathway sensitivity across omics levels",
       color = "Omics level")

# === 4) Trend 분포 비교 ===
trendplot(multiomics_res,
          group = "path_class",
          facetby = "omics_level") +
  theme_bw()

# === 5) 특정 Pathway의 Dose-response 곡선 비교 ===
# 예: "Energy metabolism" pathway
energy_res <- multiomics_res[multiomics_res$path_class == "Energy metabolism", ]

curvesplot(energy_res,
           facetby = "path_class",
           facetby2 = "omics_level",
           colorby = "trend",
           scaling = TRUE,
           npoints = 100) +
  theme_bw() +
  labs(title = "Energy metabolism: dose-response curves")
```

### 1.4 Level간 정량적 비교

```r
# === Pathway별 median BMD 계산 ===
library(dplyr)

pathway_summary <- multiomics_res %>%
  group_by(path_class, omics_level) %>%
  summarise(
    n_items = n(),
    median_BMD = median(BMD.zSD, na.rm = TRUE),
    q25_BMD = quantile(BMD.zSD, 0.25, na.rm = TRUE),
    q75_BMD = quantile(BMD.zSD, 0.75, na.rm = TRUE),
    .groups = "drop"
  )

# 결과 확인
print(pathway_summary)

# 히트맵으로 시각화
library(tidyr)
pathway_wide <- pathway_summary %>%
  select(path_class, omics_level, median_BMD) %>%
  pivot_wider(names_from = omics_level, values_from = median_BMD)

library(pheatmap)
pathway_matrix <- as.matrix(pathway_wide[, -1])
rownames(pathway_matrix) <- pathway_wide$path_class

pheatmap(pathway_matrix,
         cluster_rows = TRUE,
         cluster_cols = FALSE,
         main = "Median BMD across omics levels",
         display_numbers = TRUE,
         number_format = "%.2f")

# === Level간 상관관계 분석 ===
# 같은 pathway 내에서 level간 BMD 상관관계
library(ggpubr)

# 예: Transcriptomics vs Proteomics
trans_proteo_comparison <- multiomics_res %>%
  select(path_class, omics_level, BMD.zSD) %>%
  pivot_wider(names_from = omics_level, 
              values_from = BMD.zSD,
              values_fn = median) %>%
  filter(!is.na(transcriptomics) & !is.na(proteomics))

ggplot(trans_proteo_comparison, 
       aes(x = transcriptomics, y = proteomics)) +
  geom_point(aes(color = path_class), size = 3) +
  geom_smooth(method = "lm", se = TRUE) +
  stat_cor(method = "pearson") +
  theme_bw() +
  labs(title = "BMD correlation: Transcriptomics vs Proteomics",
       x = "BMD (Transcriptomics)",
       y = "BMD (Proteomics)")
```

### 1.5 Group 선택 및 집중 분석

```r
# 민감한 pathway 선택 (여러 level에서 공통으로 나타나는)
selected_pathways <- selectgroups(multiomics_res,
                                   group = "path_class",
                                   explev = "omics_level",
                                   BMDmax = 1.0,
                                   BMDtype = "zSD",
                                   BMDsummary = "first.quartile",
                                   nitems = 5,
                                   keepallexplev = TRUE)

# 선택된 pathway 시각화
bmdplotwithgradient(selected_pathways,
                    BMDtype = "zSD",
                    scaling = TRUE,
                    facetby = "path_class",
                    facetby2 = "omics_level",
                    line.size = 1.5) +
  theme_bw()

# 선택된 pathway의 상세 정보
selected_summary <- selected_pathways %>%
  group_by(path_class, omics_level) %>%
  summarise(
    n = n(),
    median_BMD = median(BMD.zSD, na.rm = TRUE),
    trend_inc = sum(trend == "inc"),
    trend_dec = sum(trend == "dec"),
    trend_U = sum(trend == "U"),
    trend_bell = sum(trend == "bell"),
    .groups = "drop"
  )

print(selected_summary)
```

## 2. Network 분석

DRomics 결과를 network 분석과 통합합니다.

### 2.1 Gene-Metabolite Network 구성

```r
library(igraph)
library(ggraph)

# === 1) Gene-Pathway-Metabolite relationship 구축 ===

# Gene-Pathway edge
gene_pathway <- trans_extended %>%
  select(gene = id, pathway = path_class, BMD = BMD.zSD, trend) %>%
  mutate(source = gene,
         target = pathway,
         edge_type = "gene_pathway")

# Pathway-Metabolite edge
pathway_metab <- metab_extended %>%
  select(pathway = path_class, metabolite = id, BMD = BMD.zSD, trend) %>%
  mutate(source = pathway,
         target = metabolite,
         edge_type = "pathway_metabolite")

# 통합
edges <- rbind(
  gene_pathway %>% select(source, target, BMD, trend, edge_type),
  pathway_metab %>% select(source, target, BMD, trend, edge_type)
)

# Node 정보
nodes <- data.frame(
  name = unique(c(edges$source, edges$target)),
  stringsAsFactors = FALSE
)

# Node type 추가
nodes$type <- case_when(
  nodes$name %in% trans_extended$id ~ "gene",
  nodes$name %in% metab_extended$id ~ "metabolite",
  TRUE ~ "pathway"
)

# BMD 정보 추가
node_bmd <- multiomics_res %>%
  group_by(id) %>%
  summarise(avg_BMD = mean(BMD.zSD, na.rm = TRUE),
            .groups = "drop")

nodes <- left_join(nodes, node_bmd, by = c("name" = "id"))

# === 2) Network 객체 생성 ===
g <- graph_from_data_frame(d = edges, vertices = nodes, directed = TRUE)

# Network 통계
cat("Nodes:", vcount(g), "\n")
cat("Edges:", ecount(g), "\n")
cat("Network density:", edge_density(g), "\n")
```

### 2.2 Network 시각화

```r
# === 기본 Network plot ===
set.seed(123)

ggraph(g, layout = "fr") +
  geom_edge_link(aes(color = edge_type), 
                 alpha = 0.5,
                 arrow = arrow(length = unit(2, 'mm'))) +
  geom_node_point(aes(color = type, size = avg_BMD), alpha = 0.8) +
  geom_node_text(aes(label = ifelse(type == "pathway", name, "")),
                 repel = TRUE, size = 3) +
  scale_color_manual(values = c("gene" = "#E41A1C",
                                 "metabolite" = "#377EB8", 
                                 "pathway" = "#4DAF4A")) +
  theme_graph() +
  labs(title = "Gene-Pathway-Metabolite Network")

# === BMD 기반 색상 매핑 ===
V(g)$bmd_category <- cut(V(g)$avg_BMD,
                         breaks = c(-Inf, 0.5, 1.0, 2.0, Inf),
                         labels = c("Very sensitive", "Sensitive", 
                                   "Moderate", "Less sensitive"))

ggraph(g, layout = "fr") +
  geom_edge_link(alpha = 0.3) +
  geom_node_point(aes(color = bmd_category, shape = type), 
                  size = 5, alpha = 0.8) +
  scale_color_viridis_d() +
  scale_shape_manual(values = c("gene" = 16, 
                                "metabolite" = 17, 
                                "pathway" = 15)) +
  theme_graph() +
  labs(title = "Network colored by BMD sensitivity")
```

### 2.3 Hub 분석 (중요 Pathway 식별)

```r
# === Centrality 계산 ===
# Degree (연결 수)
V(g)$degree <- degree(g)

# Betweenness (중개 역할)
V(g)$betweenness <- betweenness(g)

# Eigenvector centrality (영향력)
V(g)$eigen <- eigen_centrality(g)$vector

# Hub pathway 식별 (pathway만)
pathway_nodes <- V(g)[V(g)$type == "pathway"]
hub_df <- data.frame(
  pathway = pathway_nodes$name,
  degree = pathway_nodes$degree,
  betweenness = pathway_nodes$betweenness,
  eigen = pathway_nodes$eigen,
  avg_BMD = pathway_nodes$avg_BMD
)

# 정렬
hub_df <- hub_df[order(-hub_df$degree), ]
print("Top 10 hub pathways:")
print(head(hub_df, 10))

# Hub pathway 시각화
library(ggrepel)

ggplot(hub_df, aes(x = degree, y = betweenness)) +
  geom_point(aes(size = avg_BMD, color = avg_BMD)) +
  geom_text_repel(aes(label = pathway), size = 3) +
  scale_color_viridis_c(direction = -1) +
  theme_bw() +
  labs(title = "Hub pathway identification",
       x = "Degree centrality",
       y = "Betweenness centrality",
       size = "Avg BMD",
       color = "Avg BMD")
```

### 2.4 Community Detection

```r
# === Community 탐지 ===
# Undirected graph로 변환
g_undirected <- as.undirected(g)

# Louvain algorithm
communities <- cluster_louvain(g_undirected)

# Community 정보 추가
V(g)$community <- membership(communities)

cat("Number of communities:", max(V(g)$community), "\n")

# Community별 통계
community_stats <- data.frame(
  node = V(g)$name,
  type = V(g)$type,
  community = V(g)$community,
  BMD = V(g)$avg_BMD
) %>%
  group_by(community) %>%
  summarise(
    n_nodes = n(),
    n_genes = sum(type == "gene"),
    n_metabolites = sum(type == "metabolite"),
    n_pathways = sum(type == "pathway"),
    avg_BMD = mean(BMD, na.rm = TRUE),
    .groups = "drop"
  )

print(community_stats)

# Community 시각화
ggraph(g, layout = "fr") +
  geom_edge_link(alpha = 0.2) +
  geom_node_point(aes(color = as.factor(community), 
                      shape = type),
                  size = 4) +
  theme_graph() +
  labs(title = "Network communities",
       color = "Community")
```

### 2.5 Subnetwork 분석 (특정 Pathway)

```r
# === 특정 pathway의 subnetwork 추출 ===
target_pathway <- "Lipid metabolism"

# 해당 pathway와 직접 연결된 노드
neighbors_out <- neighbors(g, V(g)[name == target_pathway], mode = "out")
neighbors_in <- neighbors(g, V(g)[name == target_pathway], mode = "in")
subnet_nodes <- c(V(g)[name == target_pathway], neighbors_in, neighbors_out)

# Subgraph 생성
subg <- induced_subgraph(g, subnet_nodes)

# Subnetwork 시각화
ggraph(subg, layout = "star") +
  geom_edge_link(aes(color = edge_type),
                 arrow = arrow(length = unit(3, 'mm')),
                 alpha = 0.6) +
  geom_node_point(aes(color = type, size = avg_BMD)) +
  geom_node_label(aes(label = name), repel = TRUE, size = 2.5) +
  scale_color_manual(values = c("gene" = "#E41A1C",
                                "metabolite" = "#377EB8",
                                "pathway" = "#4DAF4A")) +
  theme_graph() +
  labs(title = paste("Subnetwork:", target_pathway))
```

### 2.6 Protein-Protein Interaction (PPI) 통합

```r
# === STRING database 등에서 PPI 정보 가져오기 (예시) ===
# 실제로는 STRINGdb 패키지 또는 파일로 불러옴

# PPI 예시 데이터 (실제로는 외부에서 가져옴)
ppi_edges <- data.frame(
  protein1 = c("ProteinA", "ProteinA", "ProteinB"),
  protein2 = c("ProteinB", "ProteinC", "ProteinC"),
  confidence = c(0.9, 0.7, 0.8)
)

# DRomics 결과와 매핑
proteo_nodes <- proteo_extended %>%
  select(protein = id, BMD = BMD.zSD, trend, pathway = path_class)

# PPI network에 BMD 정보 추가
ppi_with_bmd <- ppi_edges %>%
  left_join(proteo_nodes, by = c("protein1" = "protein")) %>%
  left_join(proteo_nodes, by = c("protein2" = "protein"),
            suffix = c("_1", "_2"))

# PPI graph 생성
g_ppi <- graph_from_data_frame(
  d = ppi_with_bmd[, c("protein1", "protein2", "confidence")],
  directed = FALSE
)

# BMD 정보 추가
bmd_info <- proteo_nodes %>%
  distinct(protein, .keep_all = TRUE)

V(g_ppi)$BMD <- bmd_info$BMD[match(V(g_ppi)$name, bmd_info$protein)]
V(g_ppi)$trend <- bmd_info$trend[match(V(g_ppi)$name, bmd_info$protein)]

# PPI network 시각화
ggraph(g_ppi, layout = "fr") +
  geom_edge_link(aes(width = confidence), alpha = 0.5) +
  geom_node_point(aes(color = BMD, shape = trend), size = 6) +
  geom_node_text(aes(label = name), repel = TRUE) +
  scale_color_viridis_c() +
  scale_edge_width(range = c(0.5, 2)) +
  theme_graph() +
  labs(title = "PPI Network with BMD information")
```

### 2.7 결과 Export

```r
# === Network 데이터 저장 ===

# 1) Cytoscape용 파일 export
write.csv(as_data_frame(g, "edges"), 
          "network_edges.csv", 
          row.names = FALSE)

write.csv(as_data_frame(g, "vertices"), 
          "network_nodes.csv", 
          row.names = FALSE)

# 2) GraphML 형식 (Cytoscape, Gephi에서 사용 가능)
write_graph(g, "network.graphml", format = "graphml")

# 3) 통계 결과 저장
write.csv(hub_df, "hub_pathways.csv", row.names = FALSE)
write.csv(community_stats, "community_stats.csv", row.names = FALSE)
write.csv(pathway_summary, "multiomics_summary.csv", row.names = FALSE)
```


1. **Multi-level 비교**: 같은 biological annotation을 사용해 여러 omics level 통합
2. **Network 분석**: Gene-Pathway-Metabolite 관계를 network로 표현하고 hub/community 분석
