# ============================================================================
# Spectra 기본 튜토리얼 — 실습용 완전판
# Mass Spectrometry Data Analysis with Bioconductor Spectra
# ============================================================================

# ============================================================================
# 0. Setup
# ============================================================================

# 패키지 설치 (최초 1회)
if (!require("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
BiocManager::install("Spectra")
BiocManager::install("msdata")

# 로드
library(Spectra)
library(S4Vectors)
library(ggplot2)
library(msdata)

# ============================================================================
# 1. DataFrame으로 Spectra 객체 생성
# ============================================================================

# metadata 정의
df <- DataFrame(
  msLevel = c(1L, 2L),
  rtime   = c(1.1, 1.2)
)

# peak 데이터 추가 (list 형식)
df$mz        <- list(c(100, 103.2, 104.3, 106.5), 
                     c(45.6, 120.4, 190.2))
df$intensity <- list(c(200, 400, 34.2, 17), 
                     c(12.3, 15.2, 6.8))

# Spectra 객체 생성
sp <- Spectra(df)
sp

# 결과 확인
length(sp)
msLevel(sp)

# ============================================================================
# 2. mzML 파일 읽기
# ============================================================================

# 예제 파일 경로
file <- system.file("sciex", 
                    "20171016_POOL_POS_1_105-134.mzML", 
                    package = "msdata")

# 파일 로드
raw <- Spectra(file)

# 기본 정보
length(raw)
head(msLevel(raw), 10)
head(rtime(raw), 10)

# ============================================================================
# 3. Metadata 및 peak data 접근
# ============================================================================

# 사용 가능한 변수 목록
spectraVariables(raw)

# metadata 테이블
spectraData(raw)[1:3, ]

# 첫 번째 스펙트럼의 peak 데이터
peaksData(raw)[[1]]

# 개별 접근
mz(raw[1])
intensity(raw[1])

# ============================================================================
# 4. MS level로 필터링
# ============================================================================

# MS1과 MS2 분리
ms1 <- filterMsLevel(raw, 1)
ms2 <- filterMsLevel(raw, 2)

# 확인
table(msLevel(raw))
length(ms1)
length(ms2)

# ============================================================================
# 5. Precursor scan과 연결된 MS2 추출
# ============================================================================

# 특정 MS1 scan의 자식 MS2들
ms_children <- filterPrecursorScan(raw, 2807)
ms_children

# MS2 개수 확인
length(ms_children) - 1  # 첫 번째는 precursor scan

# ============================================================================
# 6. TIC (Total Ion Current) 플롯
# ============================================================================

# MS1 TIC 추출
tic <- spectraData(ms1)$totIonCurrent
rt  <- spectraData(ms1)$rtime

# 플롯
plot(rt, tic, type = "l", 
     xlab = "Retention Time (s)", 
     ylab = "Total Ion Current")
abline(v = rtime(raw)[2807], col = "red", lty = 2)

# ============================================================================
# 7. MS1 스펙트럼 시각화
# ============================================================================

# 단일 스펙트럼 플롯
plotSpectra(raw[2807], xlim = c(400, 1000))

# ============================================================================
# 8. Precursor m/z 표시
# ============================================================================

# MS2 스펙트럼들의 precursor m/z 추출
precursors <- precursorMz(ms_children)[-1]

# MS1에 precursor 위치 표시
plotSpectra(raw[2807], xlim = c(400, 1000))
abline(v = precursors, col = "grey", lty = 2)

# ============================================================================
# 9. Isotopic envelope 확대
# ============================================================================

# 동위원소 패턴 확인
plotSpectra(raw[2807], 
            xlim = c(521.2, 522.5), 
            type = "l")

# ============================================================================
# 10. MS2 스펙트럼 일괄 플롯
# ============================================================================

# precursor 제외한 MS2들만
plotSpectra(ms_children[-1])

# ============================================================================
# 11. Peak labeling
# ============================================================================

# labeling 함수 정의
mzLabel <- function(z) {
  p <- peaksData(z)[[1]]
  lbl <- format(p[, "mz"], digits = 4)
  lbl[p[, "intensity"] < 1e5] <- ""
  return(lbl)
}

# 적용
plotSpectra(ms_children[7], 
            xlim = c(126, 132), 
            labels = mzLabel)

# ============================================================================
# 12. 여러 파일 동시 로딩
# ============================================================================

# 폴더 내 모든 파일
fls <- dir(system.file("sciex", package = "msdata"), 
           full.names = TRUE)

# 일괄 로드
sp_multi <- Spectra(fls)

# 파일별 스펙트럼 개수
table(dataOrigin(sp_multi))

# ============================================================================
# 13. Backend 변경
# ============================================================================

# In-memory (빠른 처리)
sp_mem <- setBackend(sp_multi, MsBackendMemory())

# HDF5 (대용량 데이터)
sp_hdf5 <- setBackend(sp_multi, 
                       MsBackendHdf5Peaks(), 
                       hdf5path = tempdir())
sp_hdf5

# ============================================================================
# 14. 복합 필터링
# ============================================================================

# 두 번째 파일만
file2 <- filterDataOrigin(sp_multi, dataOrigin(sp_multi)[2])

# retention time 범위
sub <- filterRt(file2, c(175, 189))

# 결과 확인
length(sub)
range(rtime(sub))

# ============================================================================
# 15. Profile → Centroid 변환
# ============================================================================

# peak picking + intensity 필터
pickPeaks(raw[2807]) |>
  filterIntensity(c(1e7, Inf)) |>
  plotSpectra(xlim = c(521.2, 522.5))

# ============================================================================
# 16. Lazy evaluation 확인
# ============================================================================

# 처리 큐에 쌓임
raw2 <- filterIntensity(raw, c(10, Inf))
raw2@processingQueue

# 큐 초기화
raw3 <- reset(raw2)

# ============================================================================
# 17. Interactive 시각화 (선택)
# ============================================================================

# 설치 필요시
# BiocManager::install("SpectraVis")

# library(SpectraVis)

# 브라우저 기반 탐색
# browseSpectra(raw)

# plotly 기반
# plotlySpectra(raw[10])

# ============================================================================
# END OF TUTORIAL
# ============================================================================
